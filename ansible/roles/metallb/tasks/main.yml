---
- name: Download MetalLB manifest
  get_url:
    url: https://raw.githubusercontent.com/metallb/metallb/v0.14.9/config/manifests/metallb-native.yaml
    dest: /tmp/metallb-native.yaml
    mode: '0644'

- name: Apply MetalLB manifest
  become: true
  shell: kubectl apply -f /tmp/metallb-native.yaml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: metallb_apply
  changed_when: "'created' in metallb_apply.stdout or 'configured' in metallb_apply.stdout"

- name: Wait for MetalLB to be ready
  become: true
  shell: kubectl wait --for=condition=Ready pods --all -n metallb-system --timeout=120s
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  retries: 3
  delay: 20

- name: Create MetalLB IP pool config
  copy:
    dest: /tmp/metallb-config.yaml
    content: |
      apiVersion: metallb.io/v1beta1
      kind: IPAddressPool
      metadata:
        name: local-pool
        namespace: metallb-system
      spec:
        addresses:
        - 192.168.0.200-192.168.0.210
      ---
      apiVersion: metallb.io/v1beta1
      kind: L2Advertisement
      metadata:
        name: local-advert
        namespace: metallb-system

- name: Apply MetalLB IP pool
  become: true
  shell: kubectl apply -f /tmp/metallb-config.yaml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: metallb_config
  changed_when: "'created' in metallb_config.stdout or 'configured' in metallb_config.stdout"
