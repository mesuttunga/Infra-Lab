---
- name: Install Envoy Gateway
  become: true
  shell: >
    kubectl apply --server-side=true --force-conflicts -f
    https://github.com/envoyproxy/gateway/releases/download/{{ envoy_gateway_version }}/install.yaml
  environment:
    KUBECONFIG: "{{ k8s_kubeconfig }}"
  register: envoy_gw_install
  changed_when: "'created' in envoy_gw_install.stdout or 'serverside-applied' in envoy_gw_install.stdout"

- name: Wait for Envoy Gateway to be ready
  become: true
  shell: kubectl wait --for=condition=Ready pods --all -n {{ envoy_gateway_namespace }} --timeout=180s
  environment:
    KUBECONFIG: "{{ k8s_kubeconfig }}"
  retries: 3
  delay: 20
  
- name: Create GatewayClass for Envoy
  become: true
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: gateway.networking.k8s.io/v1
    kind: GatewayClass
    metadata:
      name: envoy
    spec:
      controllerName: gateway.envoyproxy.io/gatewayclass-controller
    EOF
  environment:
    KUBECONFIG: "{{ k8s_kubeconfig }}"
  register: gatewayclass_apply
  changed_when: "'created' in gatewayclass_apply.stdout or 'configured' in gatewayclass_apply.stdout"
